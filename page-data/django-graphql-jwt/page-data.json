{"componentChunkName":"component---src-templates-blog-post-js","path":"/django-graphql-jwt/","result":{"data":{"site":{"siteMetadata":{"title":"Mindscape"}},"markdownRemark":{"id":"0f150bdd-c451-5296-838f-82496d5727e1","excerpt":"Summary: I integrated JWT auth to my Django application that uses RESTful and GraphQL You can check the repo here: https://github.com/asvrada/home-dashboard…","html":"<blockquote>\n<p>Summary: I integrated JWT auth to my Django application that uses RESTful and GraphQL<br>\nYou can check the repo here: <a href=\"https://github.com/asvrada/home-dashboard-backend\">https://github.com/asvrada/home-dashboard-backend</a></p>\n</blockquote>\n<h2>The Goal / Expected outcome</h2>\n<p>Goal: To enable user authentication by JWT in your Django application’s RESTful API and GraphQL API.</p>\n<p>In this article, I assume the two library that implement these 2 type of APIs are:</p>\n<ul>\n<li><a href=\"https://www.django-rest-framework.org/\">Django REST framework</a></li>\n<li><a href=\"https://github.com/graphql-python/graphene-django\">graphene-django</a></li>\n</ul>\n<p>For example, there is this Django application that expose two APIs:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># RESTful API</span>\n<span class=\"token operator\">/</span>user<span class=\"token operator\">/</span>\n\n<span class=\"token comment\"># GraphQL API</span>\n<span class=\"token operator\">/</span>graphql<span class=\"token operator\">/</span></code></pre></div>\n<p>And after reading this article, you will be able to build an application where you can query both endpoints with the same JWT token (after fetching the token) like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/2177d9038bd1e287002bbc9a349bed13/ee787/postman.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.054054054054056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA60lEQVQY03WPWVLEMAxEfUqOwam4AFfhD/6pTCBDvFuOl552IEWgQFXPtiypJalVa2hj8b4smOcZmr4x5l9GfNREp/EyOdw9ONw/eszLusdUchZ6eoVeLnB8+xiQJEFE4L1HSgk5Z8QY+S+oraHUikZCrniaKp7fKoS1m7dQMQQIyRKJ7MlDyFrLBu4HKXhkIt5BYtjzUQW9JPRaULcN6sI1j7Uti8Y0GwPHZGPSQWDTRKFMCsVq5rRsXkrFRlrvaK1D2fUDUV8R1yvErGilMKkw2HC289qd/g5FfqN44pv2eX/ZOfFsfwkd3AD5ZdFYPT5XvwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"postman example\"\n        title=\"postman example\"\n        src=\"/blog/static/2177d9038bd1e287002bbc9a349bed13/fcda8/postman.png\"\n        srcset=\"/blog/static/2177d9038bd1e287002bbc9a349bed13/12f09/postman.png 148w,\n/blog/static/2177d9038bd1e287002bbc9a349bed13/e4a3f/postman.png 295w,\n/blog/static/2177d9038bd1e287002bbc9a349bed13/fcda8/postman.png 590w,\n/blog/static/2177d9038bd1e287002bbc9a349bed13/efc66/postman.png 885w,\n/blog/static/2177d9038bd1e287002bbc9a349bed13/c83ae/postman.png 1180w,\n/blog/static/2177d9038bd1e287002bbc9a349bed13/ee787/postman.png 2022w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>The Problem</h2>\n<p>Indeed, each library (REST framework and graphene-django) comes with its own JWT plugin/extension:</p>\n<ul>\n<li><a href=\"https://github.com/SimpleJWT/django-rest-framework-simplejwt\">djangorestframework-simplejwt</a></li>\n<li><a href=\"https://django-graphql-jwt.domake.io/en/latest/\">django-graphql-jwt</a></li>\n</ul>\n<p>But these two library don’t work with each other out-of-the-box. In other words, JWT token obtained from RESTful JWT endpoint won’t work with GraphQL endpoints, and vice versa.</p>\n<h2>Solution</h2>\n<p>I know there might be a way to configure these 2 JWT libraries so that they work with each other. However I take a different approach: customize entire Django application to make it use RESTful JWT library.</p>\n<p>Since my Django application is a pure backend server with only RESTful and GraphQL API exposed, enforcing JWT to every endpoint works for my use case.</p>\n<p>I will skip the usual Django application creation/setup step since there is plenty of such tutorial.</p>\n<h3>backend</h3>\n<p>The first step is to create a custom Django authentication backend. A Django authentication backend will try to find the correct user given the request, like username and password, however, in this case it will take the JWT in the header and try to authenticate the user.</p>\n<blockquote>\n<p>How to write custom authentication<br>\n<a href=\"https://docs.djangoproject.com/en/3.0/topics/auth/customizing/#specifying-authentication-backends\">https://docs.djangoproject.com/en/3.0/topics/auth/customizing/#specifying-authentication-backends</a></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># file: backend/backends.py</span>\n<span class=\"token keyword\">from</span> rest_framework_simplejwt<span class=\"token punctuation\">.</span>authentication <span class=\"token keyword\">import</span> JWTAuthentication\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">JWTBackend</span><span class=\"token punctuation\">:</span>\n    authenticator <span class=\"token operator\">=</span> JWTAuthentication<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">authenticate</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> request <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span>\n\n        <span class=\"token comment\"># calls restful jwt auth</span>\n        tuple_user <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>authenticator<span class=\"token punctuation\">.</span>authenticate<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>tuple_user<span class=\"token punctuation\">)</span> <span class=\"token keyword\">is</span> <span class=\"token builtin\">tuple</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> tuple_user<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span></code></pre></div>\n<p>And, add this backend we created to <code class=\"language-text\">settings.py</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">AUTHENTICATION_BACKENDS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'backend.backends.JWTBackend'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.contrib.auth.backends.ModelBackend'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>If the JWT token is valid, this method will return a Django’s <code class=\"language-text\">User</code> object of the authenticated user.</p>\n<h3>middleware</h3>\n<p>Now we have the backend that will take a JWT and process it to authenticate user, but we are not calling it yet. We can invoke it by adding a step to the middleware of our Django application.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># file: backend/middleware.py</span>\n<span class=\"token keyword\">import</span> logging\n\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth <span class=\"token keyword\">import</span> authenticate\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">JWTAuthMiddleware</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> get_response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>get_response <span class=\"token operator\">=</span> get_response\n        <span class=\"token comment\"># One-time configuration and initialization.</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__call__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Code to be executed for each request before</span>\n        <span class=\"token comment\"># the view (and later middleware) are called.</span>\n\n        logging<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string\">\"JWTAuthMiddleware called\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># authenticate user</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n            user <span class=\"token operator\">=</span> authenticate<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> user <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span> <span class=\"token keyword\">and</span> user<span class=\"token punctuation\">.</span>is_authenticated<span class=\"token punctuation\">:</span>\n                logging<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string\">\"JWTAuthMiddleware user set \"</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                request<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> user\n        <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> err<span class=\"token punctuation\">:</span>\n            logging<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string\">\"JWTAuthMiddleware failed \"</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        response <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>get_response<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># Code to be executed for each request/response after</span>\n        <span class=\"token comment\"># the view is called.</span>\n\n        <span class=\"token keyword\">return</span> response</code></pre></div>\n<p>Note <code class=\"language-text\">django.contrib.auth.authenticate</code> will try each authentication backend in the <code class=\"language-text\">settings.py</code> until one returns a valid <code class=\"language-text\">User</code> object.</p>\n<p>Also you could see that this middleware doesn’t have much things to do with <code class=\"language-text\">JWT</code>, it just calls the backend to auth the request. </p>\n<p>And, add this middleware to <code class=\"language-text\">settings.py</code></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">MIDDLEWARE <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token string\">'backend.middleware.JWTAuthMiddleware'</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<h2>Usage</h2>\n<p>Now everything is ready. However you will have to only use <code class=\"language-text\">rest_framework_simplejwt</code>’s views to interact with JWT token (like obtaining one, verifying one and refreshing one)</p>\n<p>Assume you have the following endpoint to obtain a JWT token, you could call this endpoint with username and password, and get token in response. Then you can use this token in your header to call RESTful and GraphQL APIs in your application.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># file: urls.py</span>\n<span class=\"token keyword\">from</span> rest_framework_simplejwt<span class=\"token punctuation\">.</span>views <span class=\"token keyword\">import</span> TokenObtainPairView\n\nurlpatterns <span class=\"token operator\">+=</span> <span class=\"token punctuation\">[</span>\n    path<span class=\"token punctuation\">(</span><span class=\"token string\">'login/'</span><span class=\"token punctuation\">,</span> TokenObtainPairView<span class=\"token punctuation\">.</span>as_view<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">=</span><span class=\"token string\">'login'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<h2>Recap</h2>\n<p>We add an authentication backend that tries to validate the JWT in an incoming request, then we add a middleware layer to call this backend to try to authenticate each request.</p>\n<p>This JWT authenticate is application-wide since we add it to the MIDDLEWARE setting. You could reduce the scope by individually adding the middleware to RESTful framework’s setting and to GraphQL’s setting.</p>\n<p>Please note JWT authentication is not enforced, which means if the request does not contain a valid token, then there will not be any error/exception thrown. However you can easily enforce authentication by adding <code class=\"language-text\">DEFAULT_PERMISSION_CLASSES</code> to rest framework’s setting and create a custom GraphQLView for GraphQL:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>mixins <span class=\"token keyword\">import</span> LoginRequiredMixin\n<span class=\"token keyword\">from</span> graphene_django<span class=\"token punctuation\">.</span>views <span class=\"token keyword\">import</span> GraphQLView\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">PrivateGraphQLView</span><span class=\"token punctuation\">(</span>LoginRequiredMixin<span class=\"token punctuation\">,</span> GraphQLView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    raise_exception <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></code></pre></div>","frontmatter":{"title":"Use JWT with Django RESTful and GraphQL","date":"July 29, 2020","category":"code"}}},"pageContext":{"slug":"/django-graphql-jwt/"}}}