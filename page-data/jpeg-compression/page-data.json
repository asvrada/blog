{"componentChunkName":"component---src-templates-blog-post-js","path":"/jpeg-compression/","result":{"data":{"site":{"siteMetadata":{"title":"Mindscape"}},"markdownRemark":{"id":"71951ff0-05dc-563d-9eb6-ed2ffc2b1215","excerpt":"某大作业要求写一个图像压缩/解压缩的软件，因此在此梳理一下过程。 大作业写完了 图像压缩有许多标准，其中属 JPEG 所提出的压缩标准最为流行，你所见到的以等后缀命名的图片，均是用此种方法压缩。注意 JPEG 是一种有损压缩方式，图片质量压缩后会有不可逆转的损失。 比较常见的无损压缩格式是PNG…","html":"<p>某大作业要求写一个图像压缩/解压缩的软件，因此在此梳理一下过程。</p>\n<blockquote>\n<p>大作业<a href=\"https://github.com/asvrada/gray-scale-jpeg-compressor\">写完了</a></p>\n</blockquote>\n<p>图像压缩有许多标准，其中属 JPEG 所提出的压缩标准最为流行，你所见到的以<code class=\"language-text\">jpeg, jpg, jpe</code>等后缀命名的图片，均是用此种方法压缩。注意 JPEG 是一种有损压缩方式，图片质量压缩后会有不可逆转的损失。</p>\n<blockquote>\n<p>比较常见的无损压缩格式是PNG</p>\n</blockquote>\n<h1>压缩流程总览</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/9846b8bfd7724cc8a0c2f34bd6bd8a10/c1b63/workflow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACzklEQVQozy2SzWtUZxSH36gBN1IFN+3GhRRcVNCVtbVFcNdKFVx0IV1IFyIiQnemBSuFEFrEf0CLtVhdqLhoYkBpzfeYycw4ncznnczcydyvuR9zZ+6dGJNonp6JLn6855x7ec55f+dVwZyiPKqY/lMxd0+ReSTxXcWk5M/vDDBxRzFxW779pZi/r/jnd6lL/uymIiH/OxOKYEbhTStckWolDxC8PMpy6lMaU3uIkopuchvRgmheEecP02neoLs8wlrrV9bdvn5j1R6h1xymXR9Ge/kzy6XrWOmvUG37MWUHsuk/KI9Jt1lFa0q6zWzb6h6WzlKxoeFGwBs2WZdzA7vVwrRtnDAmVWhSNTcwisMoa/ESxdIzaslzAhFQcr/oY1qzO3EF2M5/TTf2CYIl3m6YAmvBps1KTyeKdNZeG2hOA7fXw8oPoeypQWoLP2D1vUgfwHRN6RZgZC8K+CCedo1sqULivyJ2YGGZRVy/TqVRJ5UvYXsGjce3iAoZbO0XlJv4gHpmSKYbwHvxIdXyQ7K5f9HnjuPObscrnqdcb5DTNMLIoi2TRt1lmnaDxWqVIDSoP31AqEnDyjUBymac1Jf4iR0CGKA1sws7fRJHfPQm+1c+RbzSJmjX5Xo23a7Bq1WHMNTx/SVCybO6ju7HmPmfUP7iaSGPkE2cI/n3R1urd1OH8Pt+CrRdPEO00sEJmrxZd/CDhuQ2nY5O26/idwRYyFEzXIw+0LOekmlCsTBJef5HvMXvaC5NYCyNyWJ2Exa+Ie6FGGaF6JUvsUOvZxHGAjA18bSCETh01zZxSldR5sIJaqnvqSa+pZa5ijP/CfWFC1K7jDM9SJA/SRwb+G6O16uy2Y5G4JVYldj38jJlAdPK4XgmduGKeNj3aur9S5/ZvnX679V/k/rzvaTGjpEZ/5z02FHSTz4j8+Rd3K9lxo+RGj1CcvQL8uP7+B9x2sB+q0XwrwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Imgur\"\n        title=\"Imgur\"\n        src=\"/blog/static/9846b8bfd7724cc8a0c2f34bd6bd8a10/fcda8/workflow.png\"\n        srcset=\"/blog/static/9846b8bfd7724cc8a0c2f34bd6bd8a10/12f09/workflow.png 148w,\n/blog/static/9846b8bfd7724cc8a0c2f34bd6bd8a10/e4a3f/workflow.png 295w,\n/blog/static/9846b8bfd7724cc8a0c2f34bd6bd8a10/fcda8/workflow.png 590w,\n/blog/static/9846b8bfd7724cc8a0c2f34bd6bd8a10/efc66/workflow.png 885w,\n/blog/static/9846b8bfd7724cc8a0c2f34bd6bd8a10/c83ae/workflow.png 1180w,\n/blog/static/9846b8bfd7724cc8a0c2f34bd6bd8a10/c1b63/workflow.png 1200w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>可以看到流程分为以下几步 </p>\n<ol>\n<li>颜色空间转换 (color space transformation)  </li>\n<li><strong>缩减像素采样 (chroma downsampling)</strong>  </li>\n<li>分块 (Block splitting)  </li>\n<li>离散余弦变换 (Discrete Cosine Transform)</li>\n<li><strong>对变换后的矩阵进行“量化” (Quantization)</strong> </li>\n<li>将2D矩阵转为1D数组，并使用常规方法无损压缩</li>\n</ol>\n<p>上述步骤中，<strong>加粗</strong>的步骤为带来图像质量损失的地方。</p>\n<h2>1. 颜色空间转换</h2>\n<p>我们都知道，计算机显示的图像一般是由RGB三色表示，简单明了。但是为了提升压缩率，我们在压缩前，事先将RGB颜色转换到YCbCr颜色空间。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/ab099679e72b4867c7f710c48d6bfb98/29007/steps.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.45945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABoklEQVQY02P4DwX/QPjfv29fv/35+/fvjx+3Zs261dt3s7P74YZNQLmvX79++PDh5o2bjx4+vn3rzpvXb4DqGRBa////+/fP46ePfv398/rBgwZm5hZGxkoGhoVent9+/b537/6ZM2eqaipbO1tLK8t37N0F0nz2xruNx97sOfVy64mXL19+ubf/7LPHz+6euuBuyMW3iJ17ORPrCobpj1v/f/+1ffu+0ESlwk6GkmaG+slsT14cZuifsT0koT0utSUqc9K+Q+dOLNx9av+By9ev1TWGMqSYsvm2MDhn2iVsunPjz4f3nyfN8fIqVLAvDrEsdKlZupmhb+ZkOyeD7BizhPTgA8cuHtj+4sKJS+8//tj1fC2PdTYzwzVWlgMMDHvWrnsKdOfeg3VyadkMqWsY0uaK5y1i+Pjp+bOXt169vf/m3Y1Xrz6ePv30y+ev37/+AIZDRtZSBgZnNjY7BobYjRsvg8Pmn/vsRQzl2QztqeJtbQz/0QEwyP///v0byDp/7vbcuVuXLt27YMHmJ09eQqT3Prs279bhRfcPr3l8EgAv3SFgQnkBEwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"RGB to YCbCr\"\n        title=\"RGB to YCbCr\"\n        src=\"/blog/static/ab099679e72b4867c7f710c48d6bfb98/fcda8/steps.png\"\n        srcset=\"/blog/static/ab099679e72b4867c7f710c48d6bfb98/12f09/steps.png 148w,\n/blog/static/ab099679e72b4867c7f710c48d6bfb98/e4a3f/steps.png 295w,\n/blog/static/ab099679e72b4867c7f710c48d6bfb98/fcda8/steps.png 590w,\n/blog/static/ab099679e72b4867c7f710c48d6bfb98/efc66/steps.png 885w,\n/blog/static/ab099679e72b4867c7f710c48d6bfb98/c83ae/steps.png 1180w,\n/blog/static/ab099679e72b4867c7f710c48d6bfb98/29007/steps.png 1600w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>RGB 转换到 Y Cb Cr 空间后，Y代表luma（亮度），Cb Cr分表代表两种色彩的浓度。由于相比色彩浓度，人眼对亮度的变化更为敏感，我们可以对Cb Cr空间的颜色信息进行适当的丢弃，提高压缩率。</p>\n<h2>2. 缩减像素采样</h2>\n<p>经过上述步骤，现在有三种颜色通道：Y Cb Cr。这一步只对 Cb Cr 通道分别进行。通过舍弃部分颜色浓度信息，提高压缩率。</p>\n<p>常见选项为4:2:0，经过这一步后原来需要8个数字表示的信息，现在只需要2个，直接抛弃了75%的Cb Cr信息。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 100px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/276d5f52fda56f72321e71b62d13a99f/7e516/422.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 166%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAhCAYAAADZPosTAAAACXBIWXMAAAsSAAALEgHS3X78AAAEyUlEQVRIx51Wa08bVxDlRyaoxTbEYBvzJVCpgqhfIjVRSdMqKmkCtEGlaRsiIiKlaUDBYDBgwNjYGPMK4AYbUx6B+gF4d+19nM5cy66hQYbeq/HMzu6eO3fuzFlX4SPDMAxcxV8+qooPsdY0A6qqi+v5+XmSIKa8XoyOubH2bk34VU2Fruuld84vUnXRyouLIfh8XsxMeOFxeRDfjF8q2lKE2ayKiYkDeDyHJNsEtgnv5AYmo3PwpqcwdejFxPoExiJjCL0PXRyhrhccu7sSLBYfTKZ5mM1DqDF9C1P1I5ifNsO08AlMM2ZYeiy4dv8abvffrgy4vy+hqcmPxsYgnE4XnE3dcDb0wvn8CzjDNjh9TjQ9a4L1sRX3fr93GcA0Af0Mh6OHQAfgaJyFw+aH4/7XcPxiheMnJ5weJ+qm69C+2F4ZcG8viYaGTlitHaivfw5rfQjWujCsX7bD2mWC9VEDGiYbUBOowZ3VO5UBP3zIoK3tGVpbn5L8gda2CFo/X0Hb42609n2G1t/acGvuFlrCLfh+49HFgOV1mMvlobAoKokGWVaRlSTk8gpJDoqmCMlr+avXIY9UKonBN2+u1DWlCLn6ZVkWks1mkU6nCTAltKwU/MfHx0ilUzg5Pam8ZX6B2y0cDsPtduPJkyfo6ekRNvsCgQD6+vrQ1dWF169fXw4wGAxSyy3C5XLh4cOHQoaHhxGJRMRivb29ePDgAQYGBioD8nZevnwpHn716hXevn0rhG328b2hoSEMDg5idna2MiDni7fDUfX394uoONoXL14IX3d3N2ZmZrCwsID19fXKgMlkEp2dnejo6BC54pz5/X5hs4/veTweIg0flpaWKgPm83lsJxKIx+PUNXvIZDIiDbwQ+xJ0j20+9ZOTk/9Xh/wiR3RRHZZL0XemU8prkkcul0MsFiv5yp89H0jRrirowgXTvyznwD5FyROgKvySIkHVifppyjlZ6PLPAKerFOHZlWQcHBQiSiQ28dfun8JeCa5C+lsS9nJgWay/tbWFzc1NrK6uCl3cRWnLisLfEQOhkAY+xEBAQdCvIZLaxlyOysUIY4mmP+fHhr5BUanQdK0UaSnCwrVBJwviQRAfAtevR3GjXkV9DXBj+gfYUINPd0yoXq+GieZXNJNHSewf7OPw8FDUZhlgkbENYus87HYVtbUJ2OxZ2GsBu/dHOGCBJVYH84YZdUYt7tPcSewgGo1SqW1jZWXlv4B7ezqBScTaEuk8AZJt1omlu0E8DbvSiEatEWbJjLvy3Qvp7MyW7XYQIGCzGQSow2Yh29cjtmzTHLAbdpgME76h+W71nTgQLnrecvGkS4AHB0BzC3DzJunmgt3sJAn+ihba9E365Ulx4juasiTj9PQUEjF6eeeUtZ5GRZyhckiTTuP9VgqxrQxih7uIJqOIZeLYPt5G/DiOncyOAOE25BZVVfUcoFG4WF4OU4IXMTU1junpCUxOjmF6cgruYTd8Xh8ioQhGhkbgcXswPj4uuJK5c21t7eOFrWm6qK/iYLt4j/8kFZJjiNorb0VN+7ceq843NzMzl8Po6KhY3TUyIjTzY9HHn4VR9yiGXcOYm5s7W9jnGYOTzB8pJtwifR0dHQk/+9hmX1E4l+UY/wDfakHH8j5+6AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Imgur\"\n        title=\"Imgur\"\n        src=\"/blog/static/276d5f52fda56f72321e71b62d13a99f/7e516/422.png\"\n        srcset=\"/blog/static/276d5f52fda56f72321e71b62d13a99f/7e516/422.png 100w\"\n        sizes=\"(max-width: 100px) 100vw, 100px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>3. 分块</h2>\n<p>这一步很简单，将图片的每一个颜色通道分别分割成大小统一的矩阵，方便后续步骤的处理。常见矩阵大小为8x8或者16x16。将较大的图片分割为较小的区块是为了使DCT所花的时间不至于太长。</p>\n<p>大部分图片的长宽并不是8或者16的整数倍，无法被完整的分块。对于分块后不足8x8的部分，通常是用0填满。</p>\n<h2>4.DCT</h2>\n<p>最神奇的一步来了。通过对上述每一个矩阵进行离散余弦变换，我们将数据转换到了频域。这一步是可逆的。</p>\n<p>一般在DCT变换前会对矩阵做一个 element-wise 的减法，即每个元素减去128。这样将矩阵里每个元素的范围从 [0, 255] 变到 [-128, 127]。</p>\n<p>略去繁琐的数学定义，DCT具体代码实现<a href=\"https://blog.csdn.net/qq_20613513/article/details/78744101\">如下</a>：意外的还挺简单的，不得不感叹数学的威力真是太强大了。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">get_dct_matrix</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    D <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">,</span> N<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> j <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> i <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n                tmp <span class=\"token operator\">=</span> math<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">/</span> N<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                tmp <span class=\"token operator\">=</span> math<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">/</span> N<span class=\"token punctuation\">)</span>\n\n            D<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> tmp <span class=\"token operator\">*</span> math<span class=\"token punctuation\">.</span>cos<span class=\"token punctuation\">(</span>math<span class=\"token punctuation\">.</span>pi <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> j <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> i <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> N<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> D\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">DCT</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    D <span class=\"token operator\">=</span> get_dct_matrix<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> np<span class=\"token punctuation\">.</span>matmul<span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>matmul<span class=\"token punctuation\">(</span>D<span class=\"token punctuation\">,</span> block<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> D<span class=\"token punctuation\">.</span>transpose<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">iDCT</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    D <span class=\"token operator\">=</span> get_dct_matrix<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> np<span class=\"token punctuation\">.</span>matmul<span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>matmul<span class=\"token punctuation\">(</span>D<span class=\"token punctuation\">.</span>transpose<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> block<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> D<span class=\"token punctuation\">)</span></code></pre></div>\n<p>DCT 变换后，虽然矩阵大小不变，但每个元素的意义已经不一样了。现在最左上角，也就是第一个元素，被称为 DC 系数，DC即Direct Current，直流。其余63个元素被称为 AC 系数，AC即Alternating Current，交流。具体含义与信号处理啥的有关，由于我不是很了解，目前无法给出更详细的解释。</p>\n<p>据我所知，AC 系数 所保留的信息不是那么重要，因此可以在这方面进行适当的舍弃，这就是下一步要做的事。</p>\n<h2>5. 量化</h2>\n<p>这一步会使用到一个标准里已经定义好的量化矩阵，大小为8x8或者16x16。然后用DCT变换后的矩阵除以（element-wise）量化矩阵，并将商取为最接近的整数。由于商本是小数，经过求整后带来了精度的损失。这一步是不可逆的，解压时无法恢复到压缩前的精度。</p>\n<p>量化后的矩阵会有大量连续的重复数字，方便下一步的无损压缩。</p>\n<p>下面举一个例子，来展示实际应用中DCT加上量化的作用：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/25b3b6e7b4e306e10ef86b77bddc7fc0/51ed8/dct.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAr0lEQVQI102OOwqDUBREXY1o5V8ExU8jPrUIWqWxFWyyJBs7V+Q6tIginPBeGgcOTHFn5mqv94tK1JRlqaiqiiiKWNcVqeu6+J4n02dC1IKmadTNEyEERVEwjiNaGIZ4nofruvi+TxAE6LrOPM+qbNs29n2nbVpM08RxHGzbxrIshe38vWEYdF2HliQJWZaR57lakcjiZVnUh/d9cxwHfd+rsTRNieMYmXsiM8Mw8AN8j38v8oaJUwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Imgur\"\n        title=\"Imgur\"\n        src=\"/blog/static/25b3b6e7b4e306e10ef86b77bddc7fc0/fcda8/dct.png\"\n        srcset=\"/blog/static/25b3b6e7b4e306e10ef86b77bddc7fc0/12f09/dct.png 148w,\n/blog/static/25b3b6e7b4e306e10ef86b77bddc7fc0/e4a3f/dct.png 295w,\n/blog/static/25b3b6e7b4e306e10ef86b77bddc7fc0/fcda8/dct.png 590w,\n/blog/static/25b3b6e7b4e306e10ef86b77bddc7fc0/efc66/dct.png 885w,\n/blog/static/25b3b6e7b4e306e10ef86b77bddc7fc0/51ed8/dct.png 1021w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/3e3e1b6f2c038ff4ff6096ddc9669bcd/d7ab4/quanti.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA2ElEQVQY0z2POw5FUBRFzUIpEn8NEolOgiGIyihUmIAZaBUKVGbgU6mMQu2XSJT75d7kOcnKytnNPoe57xvneeK6Luo/ZD+OA8/z4D/btmEYBszzjGmaMI4jNdlJvq4rmDAM4bougiCA53kfvu/Dtm0URYF932lBVVWQZRmmaVIMw6BYlgVFURDHMRjHccDzPERR/BAEAZIkgWVZJElCr3zfF2VZguM46LoOTdMoqqpSkzyKIjB936NpGrRtS+m67nNd11iW5XuZvEgK8jxHlmWUNE2pSU4Kf3jJzkT+v66MAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Imgur\"\n        title=\"Imgur\"\n        src=\"/blog/static/3e3e1b6f2c038ff4ff6096ddc9669bcd/fcda8/quanti.png\"\n        srcset=\"/blog/static/3e3e1b6f2c038ff4ff6096ddc9669bcd/12f09/quanti.png 148w,\n/blog/static/3e3e1b6f2c038ff4ff6096ddc9669bcd/e4a3f/quanti.png 295w,\n/blog/static/3e3e1b6f2c038ff4ff6096ddc9669bcd/fcda8/quanti.png 590w,\n/blog/static/3e3e1b6f2c038ff4ff6096ddc9669bcd/efc66/quanti.png 885w,\n/blog/static/3e3e1b6f2c038ff4ff6096ddc9669bcd/d7ab4/quanti.png 1014w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>可以看到量化后，大量的元素现在变成了0，极大的压缩了原本的信息。</p>\n<p>再来看看压缩后恢复的数据是什么样的，通过做上述步骤的拟变换，我们得到了：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/f19d2e3831d68af2b35a319f535553b5/167b5/before.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAA9ElEQVQoz02RVw6AMAxDuQ+z7L0R3P9CQS9Sqn5A27h27DTa913yPJd5nvVL01SoVVWl33EckiSJrn3f6937vnXtuk7rcM7zlHEcJVrXVZxzekAwyzIF27b1gpC3bZNhGHR/XZdyaGA4nGmaJOJXFIUsy+IFITRNoyTcUgOjqeFgOKQRNVyrIAQEOSCKfQhcjuNY66GgxQsFzaFGxjKCxDEyIA7LshRGAoFmjCGMjKDh6KigdcOBCT7P42dokY1AcziszNAEuaeCYWSbUfjKuDHB8JXh4NAa+keBANEEzQEO67qW9319jdjsv+9TzF6ZhOCk/AGMsQlyZyBiqwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Imgur\"\n        title=\"Imgur\"\n        src=\"/blog/static/f19d2e3831d68af2b35a319f535553b5/fcda8/before.png\"\n        srcset=\"/blog/static/f19d2e3831d68af2b35a319f535553b5/12f09/before.png 148w,\n/blog/static/f19d2e3831d68af2b35a319f535553b5/e4a3f/before.png 295w,\n/blog/static/f19d2e3831d68af2b35a319f535553b5/fcda8/before.png 590w,\n/blog/static/f19d2e3831d68af2b35a319f535553b5/167b5/before.png 776w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>一堆数字而已，看不出来什么，让我们观察一下转换前后数据的差值：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/2f2c7b6dafd97171698d44ddae2b85ee/940c5/after.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8ElEQVQoz3XSa46CQBAEYK+DICDKW4L3v1Rvvkl6s5rsD3Smuqq6uuGyrmv0fR/3+z22bYvr9Rqw5/MZVVXFPM/Rtm0syxLjOEbTNAXruq7g+75HXdcxTVPRXRCHYSgEhkjv97uIGCKp4eAyhAmAexxHwTRjfuGs6D+7KXqcYYQ4DGGv16s0oNGcIUygkhA5ExIY99uQgWQ5ciZkBKMphn6QFdPwb0KCNNTcjiVzd4bdbreCFUPdvg0VPc65w8fjUZJlQwkZafhhmDv8b+R8Ue65w1xTvuWPkXVwQcgisTRGUleDEajj0TA8z/P3y8D9ASOeAC0h98tQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Imgur\"\n        title=\"Imgur\"\n        src=\"/blog/static/2f2c7b6dafd97171698d44ddae2b85ee/fcda8/after.png\"\n        srcset=\"/blog/static/2f2c7b6dafd97171698d44ddae2b85ee/12f09/after.png 148w,\n/blog/static/2f2c7b6dafd97171698d44ddae2b85ee/e4a3f/after.png 295w,\n/blog/static/2f2c7b6dafd97171698d44ddae2b85ee/fcda8/after.png 590w,\n/blog/static/2f2c7b6dafd97171698d44ddae2b85ee/940c5/after.png 772w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>可以发现，转换前后误差最大也不过6%。</p>\n<h2>6. 无损压缩</h2>\n<p>接下来的步骤专注于如何最大化的无损压缩上述步骤产生的数据，以块为单位。</p>\n<h3>1. zigzag</h3>\n<p>这一步将2D矩阵通过如下图所示的Z字形扫描转换为1D数组。由于DCT+量化后，高频部分（即矩阵右下部分）的数值通常比较相似，或者干脆是大片的0，因此经过zigzag转换能将这一片数值相近的数字集中起来，方便下一步的压缩。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/7d4d33646ecfcca622ccfa6eb14ae46c/ae694/zig.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"zig\"\n        title=\"zig\"\n        src=\"/blog/static/7d4d33646ecfcca622ccfa6eb14ae46c/fcda8/zig.png\"\n        srcset=\"/blog/static/7d4d33646ecfcca622ccfa6eb14ae46c/12f09/zig.png 148w,\n/blog/static/7d4d33646ecfcca622ccfa6eb14ae46c/e4a3f/zig.png 295w,\n/blog/static/7d4d33646ecfcca622ccfa6eb14ae46c/fcda8/zig.png 590w,\n/blog/static/7d4d33646ecfcca622ccfa6eb14ae46c/ae694/zig.png 850w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>Zigzag ordering</em></p>\n<h3>2. 编码 DC/AC 系数</h3>\n<p>上文提到矩阵的第一个数值为DC系数，剩下的63个数值为AC系数。这两种系数会被分别编码。</p>\n<h4>DC</h4>\n<p>由于DC通常较大，因此每个块的DC单独拿出来进行差分编码 (differential encoding) 。</p>\n<p>编码\n$$Diff<em>i = DC</em>i - DC_{i-1}$$</p>\n<p>解码\n$$DC<em>i = Diff</em>i + DC_{i-1}$$</p>\n<blockquote>\n<p>比如某4个块的4个DC系数为 200 201 202 203，他们将被表示成 200 1 1 1<br>\n处理后的数字代表<strong>压缩前</strong>的当前数值与上一个数值的差值。</p>\n</blockquote>\n<h4>AC</h4>\n<p>AC系数数值普遍较小且多为0，因此采用类似run-length encoding的方法编码。</p>\n<p>在进行上述步骤的同时，还要将数字进行哈夫曼编码进一步压缩储存空间。由于过于繁琐。。。我懒得解释了。。。。</p>\n<hr>\n<p>最终使用哈夫曼编码系数之后，我们就得到了一串二进制数据，将这串数据附上合适的头部（块大小，量化表质量，图片大小等等）输出到文件即可。详细过程还请参考文章开头的项目链接。</p>\n<hr>\n<p>哎，看<a href=\"https://en.wikipedia.org/wiki/JPEG\">维基</a>去吧，反正都是从上面抄的，我又是复读机了。</p>","frontmatter":{"title":"JPEG图像压缩过程","date":"November 13, 2018","category":"code"}}},"pageContext":{"slug":"/jpeg-compression/"}}}